{"componentChunkName":"component---src-templates-blog-post-js","path":"/wordpress-custom-block-plugin/","result":{"data":{"site":{"siteMetadata":{"title":"rafhun"}},"markdownRemark":{"id":"99673c62-dd83-5b4e-8ff0-35e969f3dc70","excerpt":"This is a possible setup for a WordPress plugin that adds a new custom editor block. Check out the full repo on Github. The plugin is based on the  packageâ€¦","html":"<p>This is a possible setup for a WordPress plugin that adds a new custom editor block. Check out the <a href=\"https://github.com/rafhun/rh-editor-block-starter/\">full repo</a> on Github. The plugin is based on the <code class=\"language-text\">@wordpress/scripts</code> package which automatically builds the necessary scripts, creates the dependency array and allows for easy enqueueing in WordPress. The file structure is supposed to be used as a starter and contains templates for standard blocks as well as dynamic (server side rendered) ones.</p>\n<p>The PHP side of things is based on an object oriented approach and makes use of composer. The plugin should thus be installed using composer if any classes are called (or you will manually have to create/copy the autoloader files).</p>\n<h2>Basic PHP Setup</h2>\n<p>As per WordPress expectations and default the main plugin logic and entry point can be found in <code class=\"language-text\">rh-editor-block-starter.php</code>. We begin by declaring the namespace and then add the usual plugin doc block with all meta information WordPress needs. Make sure to add the plugin title as a translated string directly after the block comment to display the title to each user in their preferred language.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">RHEditorBlockStarter</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * Plugin Name: RH Editor Block Starter\n * ... [add more plugin meta information] ...\n */</span>\n<span class=\"token function\">__</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'RH Editor Block Starter'</span><span class=\"token punctuation\">,</span> <span class=\"token single-quoted-string string\">'rh-editor-block-starter'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Exit if accessed directly.</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'ABSPATH'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">exit</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Check for 'local' autoloader and include it if there is one.</span>\n<span class=\"token comment\">// This is a fallback for cases where the plugin was not installed using composer.</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__DIR__</span> <span class=\"token punctuation\">.</span> <span class=\"token single-quoted-string string\">'/vendor/autoload.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">require</span> <span class=\"token constant\">__DIR__</span> <span class=\"token punctuation\">.</span> <span class=\"token single-quoted-string string\">'/vendor/autoload.php'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Initialize the plugin</span>\nPlugin<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre></div>\n<p>Check out the full example file on <a href=\"https://github.com/rafhun/rh-editor-block-starter/blob/master/rh-editor-block-starter.php\">Github</a>. We initialize the <code class=\"language-text\">Plugin</code> class with the <code class=\"language-text\">__FILE__</code> magic constant, since this is used in several places throughout the plugin. In <code class=\"language-text\">Plugin</code> we make this available in a private property.</p>\n<p>All other plugin logic is placed within the <code class=\"language-text\">src</code> folder. Since the plugin is based on <code class=\"language-text\">psr-4</code> make sure to name folders and files appropriately. Our plugin initializer lives in <code class=\"language-text\">src/Plugin.php</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">RHEditorBlockStarter</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Plugin</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/**\n   * The location (__FILE__ constant of the main plugin file) of the plugin.\n   *\n   * @var string\n   */</span>\n  <span class=\"token keyword\">private</span> <span class=\"token variable\">$pluginFile</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/**\n   * Constructor.\n   *\n   * @param string $file\n   */</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n      <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">pluginFile</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$file</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * Static class initializer that hooks into WordPress\n   *\n   * @param string $file\n   */</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n      <span class=\"token variable\">$self</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">self</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token function\">add_action</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'plugins_loaded'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token variable\">$self</span><span class=\"token punctuation\">,</span> <span class=\"token single-quoted-string string\">'loadTextDomain'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">add_action</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'wp_loaded'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token variable\">$self</span><span class=\"token punctuation\">,</span> <span class=\"token single-quoted-string string\">'initBlock'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">/** Initialize a custom post type */</span>\n      <span class=\"token comment\">// CustomPostType::init();</span>\n      <span class=\"token comment\">/** Uncomment if you use server-side render */</span>\n      <span class=\"token comment\">// EditorBlock\\Render::init();</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>We make use of a static initializer that sets up the plugin and hooks into WordPress. The <code class=\"language-text\">init</code> function expects the magic constant <code class=\"language-text\">__FILE__</code> as its argument which is then passed to the class constructor which stores it in a private property.</p>\n<p>The initializer is also where you can initialize a custom post type or a server side rendered block.</p>\n<h3>Translation Setup</h3>\n<p>To make translated strings available where WordPress i18n functions were used we need to load the text domain. The method we need is already hooked to the <code class=\"language-text\">plugins_loaded</code> action and called <code class=\"language-text\">loadTextDomain</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">RHEditorBlockStarter</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Plugin</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token comment\">/**\n   * Load plugin text domain\n   */</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">loadTextDomain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">load_plugin_textdomain</span><span class=\"token punctuation\">(</span>\n      <span class=\"token single-quoted-string string\">'rh-editor-block-starter'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token boolean constant\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span><span class=\"token function\">plugin_basename</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">pluginFile</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span> <span class=\"token single-quoted-string string\">'/languages'</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>This is just the basic WordPress <code class=\"language-text\">load_plugin_textdomain()</code> function, where we add the text domain as first argument, a deprecated second argument and the path to the folder where the <code class=\"language-text\">.mo</code> file is stored. There we make use of the stored <code class=\"language-text\">__FILE__</code> constant.</p>\n<h3>Block Initializer</h3>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">RHEditorBlockStarter</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Plugin</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token comment\">/**\n   * Block initializer: handles registering the script, styles and block type, as well as script translations.\n   */</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">initBlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Load the asset file generated by `@wordpress/scripts` build</span>\n    <span class=\"token variable\">$assetFilePath</span> <span class=\"token operator\">=</span> <span class=\"token function\">plugin_dir_path</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">pluginFile</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span> <span class=\"token single-quoted-string string\">'build/index.asset.php'</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Bail if there is no asset file</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$assetFilePath</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean constant\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token variable\">$assetFile</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$assetFilePath</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">wp_register_script</span><span class=\"token punctuation\">(</span>\n      <span class=\"token single-quoted-string string\">'rh-editor-block-starter-editor-js'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">plugins_url</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'build/index.js'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">pluginFile</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token variable\">$assetFile</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'dependencies'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token variable\">$assetFile</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'version'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">wp_register_style</span><span class=\"token punctuation\">(</span>\n      <span class=\"token single-quoted-string string\">'rh-editor-block-starter-editor-css'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">plugins_url</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'assets/styles/editor.css'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">pluginFile</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'wp-edit-blocks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">filemtime</span><span class=\"token punctuation\">(</span>\n        <span class=\"token function\">plugin_dir_path</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">pluginFile</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span> <span class=\"token single-quoted-string string\">'assets/styles/editor.css'</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Pretty much the same logic for fronted styles, just with a different or an empty dependency array.</span>\n\n    <span class=\"token comment\">// Delete the following if you have a server side rendered block. If you add several blocks using the plugin, add them here as well.</span>\n    <span class=\"token function\">register_block_type</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'rafhun/rh-editor-block-starter'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token single-quoted-string string\">'editor-script'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'rh-editor-block-starter-editor-js'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token single-quoted-string string\">'editor_style'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'rh-editor-block-starter-editor-css'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Set up the JS translation functions</span>\n    <span class=\"token function\">wp_set_script_translations</span><span class=\"token punctuation\">(</span>\n      <span class=\"token single-quoted-string string\">'rh-editor-block-starter-editor-js'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Script handle</span>\n      <span class=\"token single-quoted-string string\">'rh-editor-block-starter'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Text domain</span>\n      <span class=\"token function\">plugin_dir_path</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">pluginFile</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span> <span class=\"token single-quoted-string string\">'languages'</span> <span class=\"token comment\">// Path to translation files</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>There is a lot going on here, everything to do with setting up a custom block. First we check for the asset file generated by <code class=\"language-text\">@wordpress/scripts</code> which returns an array with different information about the generated script file. We make use of this information to register the block script (<code class=\"language-text\">wp_register_script</code>) and styles (<code class=\"language-text\">wp_register_style</code>) which then are used to register the block itself (<code class=\"language-text\">register_block_type</code>). Finally we use <code class=\"language-text\">wp_set_script_translations</code> to set up translations for strings in scripts that make use of WordPress i18n functions (such as <code class=\"language-text\">__()</code>).</p>\n<p>You can find the <a href=\"https://github.com/rafhun/rh-editor-block-starter/blob/master/src/Plugin.php\">full file</a> in its repo.</p>\n<h2>Basic JS Setup</h2>\n<p>Our Javascript folder structure and code organization follows the example of the WordPress core blocks. The <code class=\"language-text\">@wordpress/scripts</code> package looks for an index file in the <code class=\"language-text\">src</code> folder and compiles scripts into the <code class=\"language-text\">build</code> folder. In our entry file we handle importing and registering our custom blocks. There is an option that allows us to easily remove core blocks (in case our custom block replaces it) which is also handled.</p>\n<p>Everything gets split up into its own partials and imported within the <code class=\"language-text\">index.js</code> file of the block, where we export the data that is given to the <code class=\"language-text\">registerBlockType</code> function. By default the following files are present for blocks and can be used to configure the block. Again this file structure follows the example given in the core blocks.</p>\n<h3><code class=\"language-text\">block.json</code></h3>\n<p>This is where all block metadata is stored. The information in this file is used for block registration in both server side and client side registration. From observing Gutenberg development it is ovious that this file will gain in importance and more and more information will be stored within it. At the moment (for core v5.5) it contains the block name, category, attributes and supports.</p>\n<h3><code class=\"language-text\">deprecated.js</code></h3>\n<p>Add to this file once you update a block and old APIâ€™s become deprecated. With the help of what is available in this file blocks can then automatically be updated to their new versions. This includes, where necessary migrating attributes or updating markup (i. e. for a new save function).</p>\n<h3><code class=\"language-text\">edit.js</code></h3>\n<p>Sets up the edit function which needs to be a Gutenberg React component. This function defines how our block will behave in the editor.</p>\n<h3><code class=\"language-text\">icon.js</code></h3>\n<p>Use this file to add your own custom icon, if one is not available in the <code class=\"language-text\">@wordpress/icons</code> package.</p>\n<h3><code class=\"language-text\">index.js</code></h3>\n<p>Imports all metadata and settings (basically all files described here), puts them together correctly and exports everything for client side registration.</p>\n<p>This file also exports a constant <code class=\"language-text\">removesBlock</code> which can be used to set up core blocks for removal.</p>\n<h3><code class=\"language-text\">save.js</code></h3>\n<p>Only available in standard blocks, since server side rendered blocks do not need a save function. The save function defines, how the attributes are compiled into HTML output. It is also a function or Gutenberg React component.</p>\n<h3><code class=\"language-text\">transforms.js</code></h3>\n<p>Use this file to define how the block can be transformed into another block (imagine transforming a paragraph to a heading block) and vice versa, so how different blocks can be transformed into this one.</p>\n<h3><code class=\"language-text\">Render.php</code></h3>\n<p>Only available for server side rendered / dynamic blocks. In this file we register the block server side and define the <code class=\"language-text\">render_callback</code> function. This function defines the markup that is computed and output on each block render.</p>\n<h2>Build</h2>\n<p>The main build process is provided by the <code class=\"language-text\">@wordpress/scripts</code> package which gives access to a few differing build commands. You can find all of the commands listed in <code class=\"language-text\">package.json</code>, the most important ones are listed below. Use <code class=\"language-text\">npm run %command%</code> or <code class=\"language-text\">yarn %command%</code> (replace %command% with the one given below, i. e. <code class=\"language-text\">npm run build</code>).</p>\n<h3><code class=\"language-text\">build</code></h3>\n<p>Generates a production ready build of your scripts.</p>\n<h3><code class=\"language-text\">start</code></h3>\n<p>Generates a development build and starts a watch task. The local port on which changes are hot reloaded will be indicated in your console.</p>\n<h3><code class=\"language-text\">makepot</code></h3>\n<p>This script requires WP CLI to be available in the PATH as it is jsut an alias for a CLI command that generates a pot file for all translatable strings in PHP and Javascript files.</p>\n<h3><code class=\"language-text\">makejson</code></h3>\n<p>Again this is an alias for a WP CLI command that looks for po files in the languages folder and generates JSON translation files which contain the translatable strings extracted from JS files. By default we do not purge the po file, so we have manually translated strings available at a later point.</p>\n<h3><code class=\"language-text\">release</code></h3>\n<p>Run this once everything is committed and ready for a release. The command first does a <code class=\"language-text\">git push</code> to make sure the online repo is up to date, then generates a build and finally runs the <code class=\"language-text\">tag-dist-files</code> script which reads in the targeted version from <code class=\"language-text\">package.json</code> and adds the build folder which otherwise is gitignored to the release. If you want to ensure full compatibility even if the plugin was not installed through composer you can also add the <code class=\"language-text\">vendor/</code> folder to the release. Configure files that are added to each release in the <code class=\"language-text\">files</code> array in <code class=\"language-text\">package.json</code>.</p>","frontmatter":{"title":"Custom WordPress Editor Blocks","date":"October 25, 2020","description":null}},"previous":{"fields":{"slug":"/animated-numbers-gsap/"},"frontmatter":{"title":"Animate a number with Greensock"}},"next":{"fields":{"slug":"/wordpress-block-patterns/"},"frontmatter":{"title":"WordPress Block Patterns"}}},"pageContext":{"id":"99673c62-dd83-5b4e-8ff0-35e969f3dc70","previousPostId":"cebca23a-8709-5f9f-b841-18bec1fd270d","nextPostId":"008323d4-af78-52b8-9dd9-3cbc5e46a169"}},"staticQueryHashes":["2460539594","2841359383"]}